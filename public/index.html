<!doctype html>
<html ng-app="MyApp">
<style>
#header {height:30px}
#main       {border:1px solid gray}
#LOGINID {width:200px}
#PW {width:200px}
.dispon {display:inline}
.dispoff{display:none}
</style>
  <head>
  </head>
  <body onload="init()" ng-controller="MyController">
    <section id="header" class="container"></section>
<!--    <div id="login" class="check-element animate-show" ng-show="login" ng-hide="logon"> -->
      
      <section id="login" class="container check-element animate-show" ng-show="login" ng-hide="logon">
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10">{{MSG}}</div>
            <div  class="col-sm-1"></div>
          </div>
        <div class="row">
          <div  class="col-sm-1"></div>
          <div  class="col-sm-3">
            <label>社員ＩＤ:</label>
          </div>
          <div  class="col-sm-4">
              <input type="text" id="LOGINID" ng-model="yourId" placeholder="社員ＩＤを入力してください" value="">
          </div>
          <div  class="col-sm-4"></div>
        </div>
        <div class="row">
          <div  class="col-sm-1"></div>
          <div  class="col-sm-3">
            <label>パスワード:</label>
          </div>
          <div  class="col-sm-4">
            <input type="password" id="PW" ng-model="yourPW" placeholder="パスワードを入力してください"" value="">
          </div>
          <div  class="col-sm-4"></div>
        </div>
        <div class="row">
          <div  class="col-sm-4"></div>
          <div  class="col-sm-4">
<!--
            <button class="btn btn-primary btn-lg" ng-model="logon" ng-click="doLogon()">LOGIN</button>
-->
            <button class="btn btn-primary btn-lg" ng-model="logon" ng-click="logonChk(yourId,yourPW)">LOGIN</button>
          </div>
          <div  class="col-sm-4"></div>
        </div>
      </section>
    </div>
    <div id="menu" class="dispoff">
      <section class="container" ng-init="actTab='Touroku'">
        <div class="row">
          <div  class="col-sm-1"></div>
          <div  class="col-sm-10">
            <ul class="nav nav-tabs" >
              <li ng-class="{ active: actTab=='Touroku' }" ng-click="actTab='Touroku'"><a href="#">社員情報登録</a></li>
              <li ng-class="{ active: actTab=='Kanri' }"   ng-click="actTab='Kanri'"  ><a href="#">勤怠管理</a></li>
              <li ng-class="{ active: actTab=='Kintai' }"  ng-click="actTab='Kintai'" ><a href="#">その他    </a></li>
            </ul>

          <div  class="col-sm-1"></div>
        </div>
        <section ng-class="{ dispoff: actTab!='Touroku' }" id="Touroku" >
          <div class="row">
          </div>
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10"><BR></div>
            <div  class="col-sm-1"></div>
          </div>
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10"><span style="text-decoration:underline">User Name:　{{myName}}</span></div>
            <div  class="col-sm-1"></div>
          </div>
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10"><HR></div>
            <div  class="col-sm-1"></div>
          </div>
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-2"><input type="text" id="ADD_ID"   ng-model="addId"   placeholder="追加する社員ID"></div>
            <div  class="col-sm-2"><input type="text" id="ADD_NAME" ng-model="addName" placeholder="追加する社員名"></div>
            <div  class="col-sm-2"><input type="text" id="ADD_PW"   ng-model="addPW"   placeholder="追加する社員パスワード"></div>
            <div  class="col-sm-2"><input type="text" id="ADD_REPW" ng-model="addRePW" placeholder="追加する社員パスワード（再入力）"></div>
            <div  class="col-sm-3"></div>
          </div>
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10"><button class="btn btn-primary btn-lg" ng-model="addMemBtn" ng-click="addMem(addId,addName,addPW,addRePW)">追加</button><hr></div>
            <div  class="col-sm-1"></div>
          </div>
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10"><input type="text" id="SERCH_ID" ng-model="searchWord" placeholder="検索ワード"></div>
            <div  class="col-sm-1"></div>
          </div>
          <div class="row">
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10">
              <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                  <thred>
                    <tr>
                      <th>社員番号</th><th>社員名</th><th>管理者フラグ</th>
                    </tr>
                  </thred>
                  <tbody>
                    <tr ng-repeat="member in memList | filter:searchWord" ng-click="selectMem(member.userid,member.username)">
                      <td>{{member.userid}}</td>
                      <td>{{member.username}}</td>
                      <td>{{member.adminflg}}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div  class="col-sm-1"></div>
          </div>
        </section>
        <section ng-class="{ dispoff: actTab!='Kanri' }" id="Kanri" >
          <div class="row" >
            <div  class="col-sm-1"></div>
            <div  class="col-sm-10">
              <div>勤怠情報</div>
              <div>{{kintaiName}}  {{kintaiYear}}-{{kintaiMonth}}</div>
              <hr>
              <div class="table-responsive">
                <table class="table table-striped table-bordered table-hover">
                  <thred>
                    <tr>
                      <th>日付</th><th>始業</th><th>終業</th>
                    </tr>
                  </thred>
                  <tbody>
                    <tr ng-repeat="kintai in kintaiList">
                      <td>{{kintai.workday}}</td><td>{{kintai.starttime}}</td><td>{{kintai.endtime}}</td></tr>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div  class="col-sm-1"></div>
          </div>
          </div>
        </section>
      </section>
    </div>
    <!--
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    
    -->
    <script src="./js/angular.min.js"></script>
    <script src="./js/angular-resource.min.js"></script>
    <link rel="stylesheet" href="./css/bootstrap.min.css">
    <!--
    <link rel="stylesheet" type="text/css" href="./css/animation.css">
    -->
    
    <script src="http://code.angularjs.org/1.2.3/angular-animate.min.js"></script>
<!--
    <script src="./js/index.js"></script>
-->
    <!-- Latest compiled and minified CSS -->

<script>
//***************************************************************************************************
// kojima-bizさん、よろしく★↓
var baseURL="./data/"; 
//***************************************************************************************************

angular.module("MyApp", ["ngResource"]);

function MyController($scope, $resource) {
  // API の URL を指定してモデルを作成
  console.log("MyController START");
  
  // query でコレクションを取得
  $scope.logonChk = function(str1,str2) {
    //クライアント側は管理ユーザーIDとパスワード「:」で繋ぎBase64エンコードしたものをAuthorizationヘッダに付加してリクエストを送信する。
    //サーバー側は認証を行いレスポンスとしてCookieにセッションIDを設定して返す。
    // POST
    var url = baseURL + "login.json"; //開発用
    //var url = baseURL + "login"; // 本番用。★
    var httpMethod = "GET";    // 開発はGETでやってる。本番時にはPOSTに変更。★
    var Contents = $resource(url,{},{login:{method:httpMethod , headers:{'Authorization':'Basic ' + btoa( str1 + ':' + str2)}}});
      
    content = Contents.login({"memId" : btoa(str1) ,"memPw" : btoa(str2)} ,function (u, getResponseHeaders){
      console.log("JSON START");
      console.log(getResponseHeaders("Set-Cookie"));
      var sessionId = getResponseHeaders("Set-Cookie");
      if(sessionId == null){
        $scope.MSG = "認証エラーです";
      }else{
        //$scope.myName = content.info.name;
        login.style.display="none";
        menu.style.display ="none";
        menu.style.display="inline";
        loadMemberList($scope, $resource);
      }
      console.log("JSON END");
    });
  };
  //ログアウトAPI
  //管理機能からログアウトする。
  //この時、セッションIDはCookieとしてリクエストヘッダに含んで送信する。
  //https://[hostname]/admin/api/1.0/logout
  //GET
  
  
  $scope.selectMem = function(memId,year,month,memName){
    //勤怠取得API
    //ユーザーと年月を入力して勤怠情報を取得する
    //この時、セッションIDはCookieとしてリクエストヘッダに含んで送信する。
    //Request URL https://[hostname]/admin/api/1.0/attendance/[userid]/[yyyy]/[MM]
    //GET
    var url = baseURL + "attendance";
    //var Contents = $resource("./data/attendance.json");
    if(year ==""){
      year=new Date().getYear()+1900;
    }
    if(month ==""){
      month=new Date().getMonth()+1;
    }
    //url+="/"+memId+"/"+year+"/"+month; //★
    var Contents = $resource(url,{},{attendance:{method:'GET',headers:{} }});
    content = Contents.attendance({"userid" : addId ,"username" : addName, "password" : addPW, "repassword": addRePW} ,function (u, getResponseHeaders){

    //content = Contents.get({"memId" : memId } ,function (){
      console.log("selectMem START");
      
      if(content.state!="0000"){
        $scope.MSG = "勤怠表示NGです";
      }else{
        loadMemberKintai($scope,content,memName);
      }
      console.log("selectMem END");
    });
     $scope.actTab='Kanri';
     console.log($scope.actTab);
  };
  $scope.addMem = function(addId,addName,addPW,addRePW){
    //
    //addMemberInfo
    //
    //ユーザー登録API
    //一般ユーザーを登録する。
    //この時、セッションIDはCookieとしてリクエストヘッダに含んで送信する。
    //Request URL https://[hostname]/admin/api/1.0/user
    // POST
    //  "userid": "user31" 6文字　半角英数字
    //, "username": "テストユーザー３１"　２０文字
    //, "password": "password"　8～16文字
    //, "repassword": "password"
    var url = baseURL + "user";
    //var Contents = $resource(url,{},{user:{method:'POST' , headers:{'Set-Cookie':sessionId}}});
    var Contents = $resource(url,{},{user:{method:'GET',headers:{} }});
        
    content = Contents.user({"userid" : addId ,"username" : addName, "password" : addPW, "repassword": addRePW} ,function (u, getResponseHeaders){
      console.log("JSON START");
      if(content.state!="0000"){
        $scope.MSG = "エラーが発生しました";
      }else{
        loadMemberList($scope, $resource);
        //$scope.memList = content.memList;
      }
      console.log("JSON END");
    });
  };

};
function init(){
  login.style.display="none";
  menu.style.display ="none";
  login.style.display="inline";
}
function loadMemberList($scope, $resource){
  //ユーザー検索API
  //ユーザー情報を検索する。
  //この時、セッションIDはCookieとしてリクエストヘッダに含んで送信する。
  //Request URL https://[hostname]/admin/api/1.0/search?limit=<取得上限>&offset=<開始位置>
  //GET
  var url = baseURL + "search";
  //var Contents = $resource(url,{},{search:{method:'GET' , headers:{'Set-Cookie':sessionId}}});
  var Contents = $resource(url,{},{search:{method:'GET',headers:{} }});
      
  content = Contents.search({"limit" : "100" ,"offset" : "0"} ,function (u, getResponseHeaders){
  //content = contents.get(function (){
    console.log("loadMemberList START");
    
    if(content.state!="0000"){
      $scope.MSG = "エラーが発生しました";
    }else{
      $scope.memList = content.body.result;
    }
    console.log("loadMemberList END");

  });
}

function loadMemberKintai($scope,content,name){
  console.log("loadMemberKintai START");
  $scope.kintaiName  = name;
  $scope.kintaiYear  = content.body.year;
  $scope.kintaiMonth = content.body.month;
  $scope.kintaiList  = content.body.list;
  
  console.log("loadMemberKintai END");
}
</script>

  </body>

</html>